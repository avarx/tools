name: Obfuscate SharpSCCM with Codecepticon
on:
  push:
    branches: [ main ]
jobs:
  obfuscate:
    runs-on: windows-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        path: main-repo

    - name: Setup .NET SDK
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '6.0.x'  # Matches SharpSCCM and Codecepticon

    - name: Clone SharpSCCM
      run: |
        git clone https://github.com/Mayyhem/SharpSCCM.git
        cd SharpSCCM
        nuget restore SharpSCCM.sln -Source "https://api.nuget.org/v3/index.json"
      shell: powershell

    - name: Build SharpSCCM
      run: |
        cd SharpSCCM
        dotnet build SharpSCCM.sln --configuration Release --no-restore
      shell: powershell

    - name: Clone Codecepticon
      run: |
        git clone https://github.com/sadreck/Codecepticon.git
      shell: powershell

    - name: Disable Post-Build Commands in Codecepticon.csproj
      run: |
        cd Codecepticon/Codecepticon
        # Backup original .csproj
        Copy-Item Codecepticon.csproj Codecepticon.csproj.bak
        # Read file as a single string to handle multi-line matches
        $content = Get-Content Codecepticon.csproj -Raw
        # Remove the PostBuild Target block
        $content = $content -replace '(?s)<Target\s+Name="PostBuild"\s+AfterTargets="PostBuildEvent"[\s\S]*?</Target>', ''
        Set-Content Codecepticon.csproj -Value $content
      shell: powershell

    - name: Debug Codecepticon Directory and .csproj
      run: |
        cd Codecepticon/Codecepticon
        Write-Output "Listing Codecepticon directory:"
        dir
        Write-Output "Listing Help directory:"
        dir Help
        Write-Output "Listing Templates directory:"
        dir Templates
        Write-Output "Content of Codecepticon.csproj:"
        Get-Content Codecepticon.csproj
      shell: powershell
      continue-on-error: true

    - name: Restore Codecepticon with Pinned Roslyn
      run: |
        cd Codecepticon/Codecepticon
        dotnet add package Microsoft.CodeAnalysis.CSharp.Workspaces --version 3.9.0
        dotnet add package Microsoft.CodeAnalysis.Workspaces.MSBuild --version 3.9.0
        dotnet restore
      shell: powershell

    - name: Build Codecepticon
      run: |
        cd Codecepticon/Codecepticon
        dotnet build --configuration Release --no-restore --output Release/net6.0
      shell: powershell

    - name: Manually Copy Required Files
      run: |
        cd Codecepticon/Codecepticon
        New-Item -ItemType Directory -Force -Path Release/net6.0/Help
        New-Item -ItemType Directory -Force -Path Release/net6.0/Templates
        Copy-Item CommandLineGenerator.html Release/net6.0/
        Copy-Item -Recurse Help/* Release/net6.0/Help/
        Copy-Item -Recurse Templates/* Release/net6.0/Templates/
      shell: powershell

    - name: Debug Build Output
      run: |
        cd Codecepticon/Codecepticon/Release/net6.0
        Write-Output "Listing Release/net6.0 directory:"
        dir
        Write-Output "Listing Release/net6.0/Help directory:"
        dir Help
        Write-Output "Listing Release/net6.0/Templates directory:"
        dir Templates
      shell: powershell
      continue-on-error: true

    - name: Obfuscate SharpSCCM
      run: |
        cd Codecepticon/Codecepticon/Release/net6.0
        ./Codecepticon.exe --action obfuscate --module csharp --solution ../../../main-repo/SharpSCCM/SharpSCCM.sln --rename-strategy random --encrypt-strings --output-mappings ../../../main-repo/obfuscated-mappings.html
      shell: powershell

    - name: Build Obfuscated SharpSCCM
      run: |
        cd main-repo/SharpSCCM
        dotnet build SharpSCCM.sln --configuration Release --no-restore
      shell: powershell

    - name: Upload Obfuscated Binary
      uses: actions/upload-artifact@v4
      with:
        name: obfuscated-sharpsccm
        path: main-repo/SharpSCCM/bin/Release/net6.0/SharpSCCM.exe
        retention-days: 7

    - name: Upload Mappings
      uses: actions/upload-artifact@v4
      with:
        name: obfuscation-mappings
        path: main-repo/obfuscated-mappings.html